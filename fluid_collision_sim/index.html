<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Fluid Collision Simulator</title>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@v0.151.3/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@v0.151.3/examples/jsm/"
        }
      }
    </script>

    <script type="text/javascript" src="GUI/dat.gui.min.js"></script>
    <style>
      body { margin: 0; }
    </style>
  </head>
  <body>
    <script id="configVelocityFrag" type="shader-code">
      precision mediump float;

      uniform vec2 gridRes;
      // uniform sampler2D dataTex;

      // uniform float initialVal;

      void main() {
        vec2 pixel  = gl_FragCoord.xy / gridRes.xy;
        float vx = pixel.x;
        float vy = pixel.y;

        //if (vx > 0.5) {
        //  gl_FragColor = vec4(1.0, 0.5, 0.0, 1.0);
        //} else {
        //  gl_FragColor = vec4(0.5, 1.0, 0.0, 1.0);
        //}
        //gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);

        gl_FragColor = vec4(vx, vy, 0.0, 1.0);
      }
    </script>
    <script id="advectFrag" type="shader-code">
      precision mediump float;

      uniform sampler2D velocity;
      uniform sampler2D advected;

      uniform vec2 gridSize;
      uniform float gridScale;
      uniform float dissipation;
      uniform float timestep;

      vec2 bilerp(sampler2D texture, vec2 p)
        {
            // add 0.5 for center of pixel
            float s = p.x - (floor(p.x - 0.5) + 0.5);
            float t = p.y - (floor(p.y - 0.5) + 0.5);

            vec4 uv;
            uv.xy = (floor(p - 0.5) + 0.5) / res.xy;
            uv.zw= (floor(p - 0.5) + 1.5) / res.xy;

            vec2 u00 = texture2D(texture, uv.xy).xy;
            vec2 u10 = texture2D(texture, uv.zy).xy;

            vec2 u0 = mix(u00, u10, s);

            vec2 u01 = texture2D(texture, uv.xw).xy;
            vec2 u11 = texture2D(texture, uv.zw).xy;

            vec2 u1 =  mix(u01, u11, s);

            return mix(u0, u1, t);
        }

      void main()
      {
          vec2 uv = gl_FragCoord.xy / gridSize.xy;
          float scale = 1.0 / gridScale;

          // trace point back in time
          vec2 p = gl_FragCoord.xy - timestep * scale * texture2D(velocity, uv).xy;

          gl_FragColor = vec4(dissipation * bilerp(advected, p), 0.0, 1.0);
      }
      
    </script>
    <script id="gridCellRenderFrag" type="shader-code">
      precision mediump float;

      uniform vec2 gridRes;
      uniform sampler2D inputTexture;

      void main() {
        vec2 pixel = gl_FragCoord.xy / gridRes;
        gl_FragColor = vec4(0.5 + 0.5 * texture2D(inputTexture, pixel).xyz, 1.0);
        //gl_FragColor = vec4(pixel.y, 0.0, pixel.x, 1.0);
        //gl_FragColor = vec4(0.5 + 0.5 * pixel.xyz, 1.0);
      }
    </script>
    <script id="particleAgeFrag" type="shader-code">
      precision mediump float;

      uniform vec2 gridRes;
      uniform float dt;
      uniform sampler2D particleAgeState;

      varying vec2 vUv;

      void main() {
        vec2 age = texture2D(particleAgeState, vUv).xy;
        age.x = age.x + dt;
        gl_FragColor = vec4(age.xy, 0.0, 1.0);
      }
    </script>
    <script id="particleSimVert" type="shader-code">
      precision mediump float;

      varying vec2 vUv;

      void main() {
        vUv = vec2(uv.x, uv.y);
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
      }
    </script>
    <script id="particleSimFrag" type="shader-code">
      precision mediump float;

      uniform vec2 gridRes;
      uniform float dt;
      uniform sampler2D initialPositions;
      uniform sampler2D particlePositions;
      uniform sampler2D particleAgeState;
      uniform sampler2D velocityField;

      varying vec2 vUv;

      void main() {
        vec2 pos = texture2D(particlePositions, vUv).xy;
        vec2 age = texture2D(particleAgeState, vUv).xy;
        vec2 velocity = texture2D(velocityField, pos * gridRes).xy;

        pos.x += 2.0 * velocity.x/gridRes.x * dt;
        pos.y += 2.0 * velocity.y/gridRes.y * dt;

        float maxAge = age.y;
        float shouldReset = mod(age.x, maxAge);

        if (shouldReset == 0.0) {
          pos = texture2D(initialPositions, vUv).xy;
        } 

        gl_FragColor = vec4(pos, 0.0, 1.0);
      }
    </script>
    <script id="particleRenderVert" type="shader-code">
      precision mediump float;

      uniform vec2 gridRes;
      uniform sampler2D particlePositions;

      void main() {
        vec2 pos = texture2D(particlePositions, position.xy).xy;

        gl_Position = projectionMatrix * modelViewMatrix * vec4( pos, 0.0, 1.0 );

        gl_PointSize = 0.6;
      }
    </script>
    <script id="particleRenderFrag" type="shader-code">
      precision mediump float;

      void main() {
        gl_FragColor = vec4(0.65, 0.70, 1.0, 1.0);
        //gl_FragColor = vec4(0.0, 0.0, 0.6, 1.0);
        //gl_FragColor = vec4(0.0, 0.0, 0.4, 1.0);
        //gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
      }
    </script>
    <script id="boundaryFrag" type="shader-code">
      precision mediump float;

      uniform float time;
      uniform sampler2D boundaryField;

      void main() {
        float boundary_exists = 1.0;
        gl_FragColor = vec4(boundary_exists, 0, 0, 1);
      }
    </script>

    <script type="module" src="src/AttributeField.js"></script>
    <script type="module" src="src/Config-inator.js"></script>
    <script type="module" src="src/GridCellRender.js"></script>
    <script type="module" src="src/ParticleAge.js"></script>
    <script type="module" src="src/ParticleSim.js"></script>
    <script type="module" src="src/ParticleRender.js"></script>
    <script type="module" src="src/main.js"></script>
  </body>
</html>