<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Fluid Collision Simulator</title>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@v0.151.3/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@v0.151.3/examples/jsm/"
        }
      }
    </script>

    <script type="text/javascript" src="GUI/dat.gui.min.js"></script>
    <style>
      body { margin: 0; }
    </style>
  </head>
  <body>
    <script id="configVelocityFrag" type="shader-code">
      precision mediump float;
      uniform float mode;
      uniform vec2 gridRes;
      // uniform sampler2D dataTex;

      // uniform float initialVal;

      void main() {
        vec2 uv = gl_FragCoord.xy / gridRes.xy;

        //gl_FragColor = vec4(gl_FragCoord.x / 1024.0, 0.0, 0.0, 1.0);
        //gl_FragColor = vec4(uv.xy, 0.0, 1.0);
        gl_FragColor = vec4(mode, 1.0 - mode, 0.0, 1.0);

        //float gradient = gl_FragCoord.x / gridRes.x;
        //gl_FragColor = vec4(gradient, 0.0, 1.0 - gradient, 1.0);
      }
    </script>
    <script id="advectFrag" type="shader-code">
      precision mediump float;

      uniform sampler2D velocity;
      uniform sampler2D advected;

      uniform vec2 gridSize;
      uniform float gridScale;

      uniform float timestep;

      vec2 bilerp(sampler2D d, vec2 p)
      {
          vec4 ij; // i0, j0, i1, j1
          ij.xy = floor(p - 0.5) + 0.5;
          ij.zw = ij.xy + 1.0;

          vec4 uv = ij / gridSize.xyxy;
          vec2 d11 = texture2D(d, uv.xy).xy;
          vec2 d21 = texture2D(d, uv.zy).xy;
          vec2 d12 = texture2D(d, uv.xw).xy;
          vec2 d22 = texture2D(d, uv.zw).xy;

          vec2 a = p - ij.xy;

          return mix(mix(d11, d21, a.x), mix(d12, d22, a.x), a.y);
      }

      void main()
      {
          vec2 uv = gl_FragCoord.xy / gridSize.xy;
          float scale = 1.0 / gridScale;

          // trace point back in time
          vec2 p = gl_FragCoord.xy - timestep * scale * texture2D(velocity, uv).xy;

          gl_FragColor = vec4(bilerp(advected, p), 0.5, 1.0);
          //gl_FragColor = vec4((texture2D(advected, uv).xy + p.xy).xy, 0.5, 1.0);
          //gl_FragColor = vec4(texture2D(advected, uv).xy, 0.5, 1.0);
      }
    </script>
    <script id="finalRenderFrag" type="shader-code">
      precision mediump float;

      uniform vec2 gridRes;
      uniform sampler2D inputTexture;

      void main() {
        vec2 pixel = gl_FragCoord.xy / gridRes.xy;
        gl_FragColor = vec4(texture2D(inputTexture, pixel).xyz, 1.0);
      }
    </script>
    <script id="finalRenderParticleVert" type="shader-code">
      precision mediump float;

      uniform vec2 gridRes;
      uniform sampler2D inputTexture;

      void main() {
        vec2 pixel = gl_FragCoord.xy / gridRes.xy;
        gl_FragColor = vec4(texture2D(inputTexture, pixel).xyz, 1.0);
      }
    </script>
    <script id="finalRenderParticleFrag" type="shader-code">
      precision mediump float;

      uniform vec2 gridRes;
      uniform sampler2D inputTexture;

      void main() {
        vec2 pixel = gl_FragCoord.xy / gridRes.xy;
        gl_FragColor = vec4(texture2D(inputTexture, pixel).xyz, 1.0);
      }
    </script>
    <script id="particleVert" type="shader-code">
      precision mediump float;
      uniform float time;
      uniform vec2 res;
      uniform sampler2D velocityField;

      varying float vAlpha;

      attribute float lifespan;
      attribute float offset;

      float custom_smoothstep(float a, float b, float x) {
        float t = clamp((x - a) / (b - a), 0.0, 1.0);
     
        return t * t * (3.0 - (2.0 * t));
      }

      void main() {
          vec3 newPos = position;
          float current = mod(offset + time, lifespan);
          float percent = current/lifespan;
          vec2 velocity = texture2D(velocityField, position.xy / res.xy).xy;

          newPos.x += 1.0 * current;
          newPos.y += 0.0 * current;

          vAlpha = custom_smoothstep(0.0, 0.05, percent);
          vAlpha -= custom_smoothstep(0.85, 1.0, percent);

          vec4 mvPos = modelViewMatrix * vec4(newPos, 1.0);
          gl_PointSize = 4.0;
          gl_Position = projectionMatrix * mvPos;
      }
    </script>
    <script id="particleFrag" type="shader-code">
      precision mediump float;
      varying float vAlpha;

      float custom_smoothstep(float a, float b, float x) {
        float t = clamp((x - a) / (b - a), 0.0, 1.0);
     
        return t * t * (3.0 - (2.0 * t));
      }

      void main() {
          float d = length(gl_PointCoord - vec2(0.5));
          float a = 1.0 - custom_smoothstep(0.0, 0.5, d);
          gl_FragColor = vec4(0.65, 0.80, 0.89, a * vAlpha);
      }
    </script>
    <script id="boundaryFrag" type="shader-code">
      precision mediump float;

      uniform float time;
      uniform sampler2D boundaryField;

      void main() {
        float boundary_exists = 1.0;
        gl_FragColor = vec4(boundary_exists, 0, 0, 1);
      }
    </script>

    <script type="module" src="src/AttributeField.js"></script>
    <script type="module" src="src/particleTracers.js"></script>
    <script type="module" src="src/Config-inator.js"></script>
    <script type="module" src="src/FinalRender.js"></script>
    <script type="module" src="src/main.js"></script>
  </body>
</html>